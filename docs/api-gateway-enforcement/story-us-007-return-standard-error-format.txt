---
memoryVersion: 1
storyId: US-007
storyTitle: Return Standard Error Format
completedDate: 2026-01-28
---

STORY: US-007 - Return Standard Error Format
============================================

DESCRIPTION:
As a gateway engineer, I want to return standard error format so that errors are consistent.

MAVEN STEPS COMPLETED:
[1, 2, 7, 10]

IMPLEMENTATION SUMMARY:
Implemented centralized error handling with ApiError class and standardized error response format. All errors now return consistent JSON structure with error code, message, and retryable flag. Error handler middleware ensures uniform error responses across all endpoints.

KEY FILES:
- src/api/middleware/error.handler.ts - Core error handling implementation
  * ApiError class with error codes and toJSON() method
  * Error response helpers (sendErrorResponse, sendError)
  * Static factory methods for common errors
  * Error logging and structured error handling utilities
- src/index.ts - Global error handler middleware
- src/api/middleware/__tests__/error.handler.test.ts - Error handler tests
- src/api/middleware/__tests__/error-format-integration.test.ts - Integration tests
- src/api/middleware/__tests__/global-error-handler-integration.test.ts - Global handler tests
- src/api/middleware/__tests__/middleware-error-format-integration.test.ts - Middleware error format tests

DECISIONS MADE:
- Error format uses nested structure: { error: { code, message, retryable, details? } }
- All error codes defined as enum for type safety
- Static factory methods for common error scenarios (projectSuspended, serviceDisabled, rateLimited, keyInvalid)
- Security-focused generic error messages to prevent information leakage
- Retryable flag indicates if client should retry the request

INTEGRATION POINTS:
- Used by all validation middleware (project-status, service-enablement, rate-limit, JWT)
- Integrated into Express global error handler in src/index.ts
- All middleware can throw ApiError which gets automatically formatted

LESSONS LEARNED:
- Centralized error handling improves consistency across the gateway
- Factory methods prevent code duplication and ensure error format consistency
- Generic error messages prevent project enumeration attacks
- Type-safe error codes (enum) catch typos at compile time
