---
memoryVersion: 1
storyId: US-007
storyTitle: Return Standard Error Format
completedDate: 2026-01-28
---

STORY: US-007 - Return Standard Error Format
========================

DESCRIPTION: As a gateway engineer, I want to return standard error format so that errors are consistent.

MAVEN STEPS COMPLETED: [1, 2, 7, 10]

IMPLEMENTATION SUMMARY:
Enhanced the existing ApiError class with RATE_LIMITED static factory method and centralized error response helpers (sendErrorResponse, sendError). Updated all inline error responses throughout the gateway to use the ApiError class, ensuring consistent error format across all endpoints. Created comprehensive integration tests (14/14 passing) and passed security audit (10/10 score).

KEY FILES:
- api-gateway/src/api/middleware/error.handler.ts - Added rateLimited(), sendErrorResponse(), sendError()
- api-gateway/src/index.ts - Updated all inline error responses to use ApiError
- api-gateway/src/snapshot/health.middleware.ts - Updated to use ApiError
- api-gateway/src/api/middleware/__tests__/middleware-error-format-integration.test.ts - 14 integration tests
- api-gateway/jest.config.js - Updated for ESM imports

DECISIONS MADE:
- Standard error format: { error: { code, message, retryable, details? } }
- Generic error messages to prevent information leakage (security)
- Helper functions for convenient error responses
- All error codes use string constants (ApiErrorCode enum)

INTEGRATION POINTS:
- All middleware now uses ApiError: project-status, service-enablement, rate-limit, jwt
- Global error handler in index.ts properly formats ApiError responses
- Existing static factory methods: projectNotFound(), projectSuspended(), serviceDisabled(), keyInvalid()

LESSONS LEARNED:
- Error format was already mostly implemented; needed consistency improvements
- RATE_LIMITED static factory was missing; added with optional details (retryAfter, resetTime)
- Security audit confirmed no sensitive data leakage in error messages
- Integration tests ensure all middleware returns consistent error format
